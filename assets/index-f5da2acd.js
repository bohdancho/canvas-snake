var q=Object.defineProperty;var m=(n,t,e)=>t in n?q(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var o=(n,t,e)=>(m(n,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}})();class y{constructor(t){o(this,"sizePx");o(this,"ctx");this.ctx=y.getContext(t);const{width:e,height:s}=t.getBoundingClientRect();t.width=e,t.height=s,this.sizePx=e}static getContext(t){const e=t.getContext("2d");if(!e)throw Error("No ctx");return e}}const u={field:{length:7},snake:{initLength:3,moveFrequencyMs:300},colors:{grid:"#6b7280",snake:"#3b82f6",food:"#ef4444"}};function f(n,t){return Math.floor(Math.random()*(t-n+1))+n}var h=(n=>(n.x_pos="x_pos",n.x_neg="x_neg",n.y_pos="y_pos",n.y_neg="y_neg",n))(h||{});function S(){const n=Object.values(h),t=f(0,n.length-1);return n[t]}function P(n,t){return n[0]!==t[0]}class l{constructor(t,e){this.x=t,this.y=e}static areEqual(t,e){return t.x===e.x&&t.y===e.y}static random(t){const e=f(0,t-1),s=f(0,t-1);return new l(e,s)}}const p={ArrowLeft:h.x_neg,ArrowRight:h.x_pos,ArrowUp:h.y_neg,ArrowDown:h.y_pos};class w{constructor(t){this.actions=t}listen(){document.addEventListener("keydown",({key:t})=>{b(t)&&this.actions.changeDirection(p[t])})}}function b(n){return Object.keys(p).includes(n)}class x{constructor(t,e,s){o(this,"color",u.colors.food);this.field=t,this.position=e,this.onEaten=s,this.field.updateSquare(e,this)}initRender(){this.field.renderSquare(this.position)}onDestroy(){this.onEaten()}}class k{constructor(t){o(this,"food");this.field=t}init(){this.generateFood()}generateFood(){this.food=new x(this.field,this.field.getRandomFreePosition(),this.onEaten.bind(this)),this.food.initRender()}onEaten(){this.generateFood()}}class c{constructor(t){o(this,"length",u.field.length);o(this,"gridColor",u.colors.grid);o(this,"squares");o(this,"squareLengthPx");this.canvas=t;const e=c.getSquareLengthPx(t,this.length);this.squareLengthPx=e,this.squares=c.getInitialSquares(t,this.length,e,this.gridColor)}initRender(){this.squares.forEach(t=>t.forEach(e=>{e.render()})),this.paintInitBorder()}updateSquare(t,e){const s=this.getSquare(t);s.entity=e}renderSquare(t){this.getSquare(t).render()}getRandomFreePosition(){const t=l.random(this.length);return this.getSquare(t).entity===null?t:this.getRandomFreePosition()}getSquare(t){return this.squares[t.y][t.x]}paintInitBorder(){this.canvas.ctx.strokeStyle=this.gridColor,this.canvas.ctx.strokeRect(0,0,this.length*this.squareLengthPx,this.length*this.squareLengthPx)}static getConnectedSquare(t,e){let{x:s,y:i}=e;switch(t){case h.x_pos:s++;break;case h.x_neg:s--;break;case h.y_pos:i++;break;case h.y_neg:i--;break}return new l(s,i)}static getLastSquare(t){const e=t.at(-1);if(!e)throw Error("getLastSquare error");return e}static isValidSquare(t,e){const{x:s,y:i}=t;return s>=0&&i>=0&&s<e&&i<e}static getSquareLengthPx(t,e){return Math.floor(t.sizePx/e)}static getInitialSquares(t,e,s,i){const r=[];for(let a=0;a<e;a++){r[a]=[];for(let d=0;d<e;d++)r[a][d]=new C(t,s,new l(d,a),i)}return r}}class C{constructor(t,e,s,i){o(this,"_entity",null);this.canvas=t,this.lengthPx=e,this.position=s,this.borderColor=i}render(){this._entity?this.paint(this._entity.color):this.clear()}get entity(){return this._entity}set entity(t){var s,i;this._entity!==t&&((i=(s=this._entity)==null?void 0:s.onDestroy)==null||i.call(s)),this._entity=t}paint(t){this.canvas.ctx.fillStyle=t,this.canvas.ctx.fillRect(this.lengthPx*this.position.x,this.lengthPx*this.position.y,this.lengthPx,this.lengthPx)}clear(){this.canvas.ctx.clearRect(this.lengthPx*this.position.x,this.lengthPx*this.position.y,this.lengthPx,this.lengthPx),this.paintBorder()}paintBorder(){this.canvas.ctx.strokeStyle=this.borderColor,this.canvas.ctx.strokeRect(this.lengthPx*this.position.x,this.lengthPx*this.position.y,this.lengthPx,this.lengthPx)}}class g{constructor(t,e,s,i){o(this,"state");this.snake=t,this.field=e,this.state=g.getInitialState(i,s,e.length),this.state.forEach(r=>e.updateSquare(r,t))}grow(t){const e=c.getLastSquare(this.state),s=c.getConnectedSquare(t,e),i=g.transpileLocation(s,this.field.length),r=this.field.getSquare(i).entity;if(r===this.snake)return{event:"collapsed"};const a=r instanceof x?"ateFood":null;return this.state.push(i),this.field.updateSquare(i,this.snake),this.field.renderSquare(i),{event:a}}trimTail(){const t=this.state.shift();if(!t)throw Error("Snake move error");this.field.updateSquare(t,null),this.field.renderSquare(t)}static transpileLocation(t,e){const s={x:t.x,y:t.y};return["x","y"].forEach(r=>{t[r]>=e&&(s[r]=0),t[r]<0&&(s[r]=e-1)}),new l(s.x,s.y)}static getInitialState(t,e,s){const r=[l.random(s)];for(let a=1;a<e;a++){const d=c.getLastSquare(r);r.push(c.getConnectedSquare(t,d))}return c.isValidSquare(c.getLastSquare(r),s)?r:g.getInitialState(t,e,s)}}class L{constructor(t,e,s,i,r){o(this,"validDirection");o(this,"requestedDirection");o(this,"moveInterval");this.field=t,this.body=e,this.onCollapse=s,this.moveFrequencyMs=i,this.validDirection=r}get direction(){return this.validDirection}set direction(t){P(this.direction,t)&&(this.requestedDirection=t)}startMoving(){this.moveInterval=setInterval(()=>this.move(),this.moveFrequencyMs)}stopMoving(){clearInterval(this.moveInterval)}move(){this.requestedDirection&&(this.validDirection=this.requestedDirection,this.requestedDirection=void 0);const{event:t}=this.body.grow(this.validDirection);if(t==="collapsed"){this.stopMoving(),this.onCollapse();return}t!=="ateFood"&&this.body.trimTail()}}class M{constructor(t,e){o(this,"color",u.colors.snake);o(this,"body");o(this,"mover");this.field=t,this.onCollapse=e;const s=S();this.body=new g(this,this.field,u.snake.initLength,s),this.mover=new L(this.field,this.body,this.onCollapse,u.snake.moveFrequencyMs,s)}startMoving(){this.mover.startMoving()}get direction(){return this.mover.direction}set direction(t){this.mover.direction=t}}class E{constructor(t){o(this,"field");o(this,"snake");o(this,"keyboard");o(this,"foodManager");const e=new y(t),s=new c(e),i=new M(s,this.onLoss);this.field=s,this.snake=i,this.keyboard=new w({changeDirection:r=>this.snake.direction=r}),this.foodManager=new k(s)}start(){this.field.initRender(),this.snake.startMoving(),this.foodManager.init(),this.keyboard.listen()}onLoss(){alert("you lost")}}const v=document.querySelector("#canvas");if(!v)throw Error("No canvas");const _=new E(v);_.start();
