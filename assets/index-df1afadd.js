var P=Object.defineProperty;var b=(n,t,e)=>t in n?P(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var a=(n,t,e)=>(b(n,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();class p{constructor(t){a(this,"sizePx");a(this,"ctx");this.ctx=p.getContext(t);const{width:e,height:s}=t.getBoundingClientRect();t.width=e,t.height=s,this.sizePx=e}static getContext(t){const e=t.getContext("2d");if(!e)throw Error("No ctx");return e}}const u={field:{length:7,resolution:5},snake:{initLength:3,moveFrequencyMs:300},colors:{snake:"#3b82f6",food:"#ef4444"}};function x(n,t){return Math.floor(Math.random()*(t-n+1))+n}var h=(n=>(n.x_pos="x_pos",n.x_neg="x_neg",n.y_pos="y_pos",n.y_neg="y_neg",n))(h||{});function E(){const n=Object.values(h),t=x(0,n.length-1);return n[t]}function F(n,t){return n[0]!==t[0]}class d{constructor(t,e){this.x=t,this.y=e}static areEqual(t,e){return t.x===e.x&&t.y===e.y}static random(t){const e=x(0,t-1),s=x(0,t-1);return new d(e,s)}}const w={ArrowLeft:h.x_neg,ArrowRight:h.x_pos,ArrowUp:h.y_neg,ArrowDown:h.y_pos};class M{constructor(t){this.actions=t}listen(){document.addEventListener("keydown",({key:t})=>{_(t)&&this.actions.changeDirection(w[t])})}}function _(n){return Object.keys(w).includes(n)}class q{constructor(t,e,s){a(this,"color",u.colors.food);this.field=t,this.location=e,this.onEaten=s,this.field.updateSquare(e,this)}initRender(){this.field.renderSquare(this.location)}onDestroy(){this.onEaten()}}class I{constructor(t){a(this,"food");this.field=t}init(){this.generateFood()}generateFood(){this.food=new q(this.field,this.field.getRandomFreeLocation(),this.onEaten.bind(this)),this.food.initRender()}onEaten(){this.generateFood()}}class D{constructor(t,e,s){a(this,"_color");this.canvas=t,this.lengthPx=e,this.location=s}set color(t){this._color!==t&&(this._color=t,t?this.paint(t):this.clear())}paint(t){this.canvas.ctx.fillStyle=t,this.canvas.ctx.fillRect(this.lengthPx*this.location.x,this.lengthPx*this.location.y,this.lengthPx,this.lengthPx)}clear(){this.canvas.ctx.clearRect(this.lengthPx*this.location.x,this.lengthPx*this.location.y,this.lengthPx,this.lengthPx)}}class v{constructor(t,e,s,i){a(this,"_entity");a(this,"pixels");this.pixels=v.getInitialPixels(t,e,s,i)}render(){this.pixels.forEach(t=>t.forEach(e=>{var s;e.color=(s=this._entity)==null?void 0:s.color}))}get entity(){return this._entity}set entity(t){var s,i;this._entity!==t&&((i=(s=this._entity)==null?void 0:s.onDestroy)==null||i.call(s)),this._entity=t}static getInitialPixels(t,e,s,i){const o=[];for(let r=0;r<i;r++){o[r]=[];for(let c=0;c<i;c++){const f=s.x*i+c,y=s.y*i+r,L=Math.floor(e/i);o[r][c]=new D(t,L,new d(f,y))}}return o}}class g{constructor(t){a(this,"length",u.field.length);a(this,"squares");a(this,"resolution",u.field.resolution);this.canvas=t;const e=t.sizePx/this.length;this.squares=g.getInitialSquares(this.canvas,e,this.length,this.resolution)}initRender(){this.squares.forEach(t=>t.forEach(e=>{e.render()}))}updateSquare(t,e){const s=this.getSquare(t);s.entity=e}renderSquare(t){this.getSquare(t).render()}getRandomFreeLocation(){const t=d.random(this.length);return this.getSquare(t).entity===void 0?t:this.getRandomFreeLocation()}getSquare(t){return this.squares[t.y][t.x]}isValidLocation(t){const{x:e,y:s}=t;return e>=0&&s>=0&&e<this.length&&s<this.length}static getConnectedLocation(t,e){let{x:s,y:i}=e;switch(t){case h.x_pos:s++;break;case h.x_neg:s--;break;case h.y_pos:i++;break;case h.y_neg:i--;break}return new d(s,i)}static getInitialSquares(t,e,s,i){const o=[];for(let r=0;r<s;r++){o[r]=[];for(let c=0;c<s;c++)o[r][c]=new v(t,e,new d(c,r),i)}return o}}class m{constructor(t){a(this,"_location");this._location=t}get location(){return this._location}}class l{constructor(t,e,s,i){a(this,"segments");this.snake=t,this.field=e,this.segments=l.getInitialSegments(this.field,i,s),this.segments.forEach(o=>this.field.updateSquare(o.location,t))}growForward(t){const e=l.getLastSegment(this.segments),s=g.getConnectedLocation(t,e.location),i=l.transpileLocation(s,this.field.length),o=this.field.getSquare(i).entity;if(o===this.snake)return{event:"collapsed"};const r=o instanceof q?"ateFood":null;return this.segments.push(new m(i)),this.field.updateSquare(i,this.snake),this.field.renderSquare(i),{event:r}}trimTail(){const t=this.segments.shift();if(!t)throw Error("Snake trimTail failed");this.field.updateSquare(t.location,void 0),this.field.renderSquare(t.location)}static transpileLocation(t,e){const s={x:t.x,y:t.y};return["x","y"].forEach(o=>{t[o]>=e&&(s[o]=0),t[o]<0&&(s[o]=e-1)}),new d(s.x,s.y)}static getInitialSegments(t,e,s){const i=d.random(t.length),r=[new m(i)];for(;r.length<s;){const f=l.getLastSegment(r),y=g.getConnectedLocation(e,f.location);r.push(new m(y))}const c=l.getLastSegment(r);return t.isValidLocation(c.location)?r:l.getInitialSegments(t,e,s)}static getLastSegment(t){const e=t.at(-1);if(!e)throw Error("Snake without segments");return e}}class C{constructor(t,e,s,i){a(this,"validDirection");a(this,"requestedDirection");a(this,"moveInterval");this.body=t,this.onCollapse=e,this.moveFrequencyMs=s,this.validDirection=i}get direction(){return this.validDirection}set direction(t){F(this.direction,t)&&(this.requestedDirection=t)}startMoving(){this.moveInterval=setInterval(()=>this.move(),this.moveFrequencyMs)}stopMoving(){clearInterval(this.moveInterval)}move(){this.requestedDirection&&(this.validDirection=this.requestedDirection,this.requestedDirection=void 0);const{event:t}=this.body.growForward(this.validDirection);if(t==="collapsed"){this.stopMoving(),this.onCollapse();return}t!=="ateFood"&&this.body.trimTail()}}class k{constructor(t,e){a(this,"color",u.colors.snake);a(this,"body");a(this,"mover");this.field=t,this.onCollapse=e;const s=E();this.body=new l(this,this.field,u.snake.initLength,s),this.mover=new C(this.body,this.onCollapse,u.snake.moveFrequencyMs,s)}startMoving(){this.mover.startMoving()}get direction(){return this.mover.direction}set direction(t){this.mover.direction=t}}class R{constructor(t){a(this,"field");a(this,"snake");a(this,"keyboard");a(this,"foodManager");const e=new p(t);this.field=new g(e),this.snake=new k(this.field,this.onLoss),this.keyboard=new M({changeDirection:s=>this.snake.direction=s}),this.foodManager=new I(this.field)}start(){this.field.initRender(),this.snake.startMoving(),this.foodManager.init(),this.keyboard.listen()}onLoss(){alert("you lost")}}const S=document.querySelector("#canvas");if(!S)throw Error("No canvas");const O=new R(S);O.start();
